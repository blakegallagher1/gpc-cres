# =============================================================================
# PostgreSQL Performance Configuration for 12-core i7 Processor
# Target: High-performance spatial queries + vector tile generation
# Hardware: 12-core i7, assumed 32GB+ RAM
# =============================================================================

# -----------------------------------------------------------------------------
# MEMORY SETTINGS (Assumes 32GB RAM - adjust proportionally if different)
# -----------------------------------------------------------------------------

# Shared memory pool - 25% of total RAM for dedicated DB server
shared_buffers = 8GB

# Effective cache size - tells optimizer about available OS cache (75% of RAM)
effective_cache_size = 24GB

# Working memory per operation (sort, hash join, etc.)
# Conservative: 128MB per operation * max_parallel_workers (48) = ~6GB peak
work_mem = 128MB

# Maintenance operations (VACUUM, CREATE INDEX, REFRESH MATERIALIZED VIEW)
# 10% of RAM for maintenance tasks
maintenance_work_mem = 3GB

# -----------------------------------------------------------------------------
# PARALLELISM (Maximize 12-core usage)
# -----------------------------------------------------------------------------

# Total parallel workers across all queries
max_parallel_workers = 12

# Max workers per gather node (parallel query execution)
max_parallel_workers_per_gather = 6

# Max background workers for maintenance tasks
max_worker_processes = 16

# Enable parallel query execution for these operations
min_parallel_table_scan_size = 8MB
min_parallel_index_scan_size = 512kB

# Force parallelism for larger scans
force_parallel_mode = off  # 'off' is safer; 'on' for testing only

# -----------------------------------------------------------------------------
# QUERY PLANNER
# -----------------------------------------------------------------------------

# Cost-based optimizer settings tuned for SSD storage
random_page_cost = 1.1  # SSD assumption (default 4.0 is for spinning disks)
effective_io_concurrency = 200  # SSD can handle high concurrency

# Enable JIT compilation for complex queries (PostGIS benefits)
jit = on
jit_above_cost = 100000

# Parallel query cost thresholds
parallel_setup_cost = 1000
parallel_tuple_cost = 0.1

# -----------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
# -----------------------------------------------------------------------------

# WAL buffers - typically 16MB is sufficient
wal_buffers = 16MB

# Checkpoint settings - balance durability vs performance
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# Max WAL size before checkpoint
max_wal_size = 4GB
min_wal_size = 1GB

# WAL compression (reduces I/O)
wal_compression = on

# -----------------------------------------------------------------------------
# VACUUM / AUTOVACUUM (Important for large spatial tables)
# -----------------------------------------------------------------------------

# Enable autovacuum for maintenance
autovacuum = on

# Autovacuum workers (use 2-3 on 12-core system)
autovacuum_max_workers = 3

# Vacuum cost limits (higher = faster cleanup, more I/O)
autovacuum_vacuum_cost_limit = 1000

# Vacuum more aggressively for spatial tables
autovacuum_naptime = 30s

# -----------------------------------------------------------------------------
# CONNECTION POOLING
# -----------------------------------------------------------------------------

# Max connections - keep conservative, use pgBouncer if needed
max_connections = 100

# -----------------------------------------------------------------------------
# STATISTICS
# -----------------------------------------------------------------------------

# Increase statistics target for better query plans on spatial columns
default_statistics_target = 500

# Track query execution stats (required for pg_stat_statements)
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# -----------------------------------------------------------------------------
# LOCALE / ENCODING
# -----------------------------------------------------------------------------

# Use C locale for faster text operations (if compatible with your data)
# lc_collate = 'C'
# lc_ctype = 'C'

# -----------------------------------------------------------------------------
# LOGGING (For performance monitoring)
# -----------------------------------------------------------------------------

# Log slow queries (> 1 second) for optimization
log_min_duration_statement = 1000

# Log autovacuum activity
log_autovacuum_min_duration = 0

# Log checkpoint activity for tuning
log_checkpoints = on

# Log connections/disconnections for debugging
log_connections = off
log_disconnections = off

# -----------------------------------------------------------------------------
# POSTGIS-SPECIFIC OPTIMIZATIONS
# -----------------------------------------------------------------------------

# No specific PostGIS settings in postgresql.conf, but ensure:
# 1. All spatial columns have GIST indexes
# 2. Statistics are gathered: ANALYZE ebr_parcels;
# 3. Materialized views are refreshed regularly
# 4. Use ST_SimplifyPreserveTopology for rendering

# =============================================================================
# IMPORTANT NOTES
# =============================================================================
#
# 1. Adjust shared_buffers, effective_cache_size, maintenance_work_mem based
#    on actual RAM. Current values assume 32GB.
#
# 2. After applying these settings:
#    sudo systemctl restart postgresql
#
# 3. Verify settings are applied:
#    SHOW shared_buffers;
#    SHOW effective_cache_size;
#    SHOW max_parallel_workers;
#
# 4. Monitor query performance:
#    SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 20;
#
# 5. For production, consider using PgBouncer for connection pooling
#
# 6. Refresh materialized view regularly (e.g., nightly cron):
#    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_parcel_intelligence;
#
# =============================================================================
