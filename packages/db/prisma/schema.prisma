generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum sku_type {
  SMALL_BAY_FLEX
  OUTDOOR_STORAGE
  TRUCK_PARKING
}

enum deal_status {
  INTAKE
  TRIAGE_DONE
  PREAPP
  CONCEPT
  NEIGHBORS
  SUBMITTED
  HEARING
  APPROVED
  EXIT_MARKETED
  EXITED
  KILLED
}

enum task_status {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELED
}

enum artifact_type {
  TRIAGE_PDF
  SUBMISSION_CHECKLIST_PDF
  HEARING_DECK_PPTX
  EXIT_PACKAGE_PDF
  BUYER_TEASER_PDF
  INVESTMENT_MEMO_PDF
  OFFERING_MEMO_PDF
  COMP_ANALYSIS_PDF
  IC_DECK_PPTX
}

enum evidence_type {
  WEB_PAGE
  PDF
  IMAGE
  TEXT_EXTRACT
}

enum run_type {
  TRIAGE
  PARISH_PACK_REFRESH
  ARTIFACT_GEN
  BUYER_LIST_BUILD
  CHANGE_DETECT
  ENRICHMENT
  INTAKE_PARSE
  DOCUMENT_CLASSIFY
  BUYER_OUTREACH_DRAFT
  ADVANCEMENT_CHECK
  OPPORTUNITY_SCAN
  DEADLINE_MONITOR
}

enum alert_frequency {
  REALTIME
  DAILY
  WEEKLY
}

enum entity_type {
  LLC
  TRUST
  CORP
  INDIVIDUAL
  @@map("entity_type")
}

enum notification_type {
  ALERT
  OPPORTUNITY
  DEADLINE
  SYSTEM
  MARKET
  AUTOMATION
}

enum notification_priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Org {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships       OrgMembership[]
  jurisdictions     Jurisdiction[]
  deals             Deal[]
  parcels           Parcel[]
  tasks             Task[]
  buyers            Buyer[]
  outreach          Outreach[]
  runs              Run[]
  evidenceSources   EvidenceSource[]
  evidenceSnapshots EvidenceSnapshot[]
  parishPackVersions ParishPackVersion[]
  artifacts         Artifact[]
  uploads           Upload[]
  conversations     Conversation[]
  entities          Entity[]
  taxEvents         TaxEvent[]
  notifications     Notification[]
  savedSearches     SavedSearch[]

  @@map("orgs")
}

model User {
  // Must match Supabase auth user id.
  id        String   @id @db.Uuid
  email     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships            OrgMembership[]
  dealsCreated           Deal[]   @relation("deal_created_by")
  tasksOwned             Task[]   @relation("task_owner_user_id")
  uploadsCreated         Upload[] @relation("upload_uploaded_by")
  conversations          Conversation[]
  notifications          Notification[]
  notificationPreferences NotificationPreference[]
  savedSearches          SavedSearch[]

  @@map("users")
}

model OrgMembership {
  orgId     String   @map("org_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @db.Text // owner|admin|member
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@index([userId])
  @@map("org_memberships")
}

model Jurisdiction {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  name            String   @db.Text
  kind            String   @db.Text // parish|city
  state           String   @db.Text
  timezone        String   @db.Text
  officialDomains String[] @map("official_domains")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org         Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  seedSources JurisdictionSeedSource[]
  deals       Deal[]
  parishPackVersions ParishPackVersion[]
  runs        Run[]

  @@index([orgId])
  @@map("jurisdictions")
}

model JurisdictionSeedSource {
  id             String   @id @default(uuid()) @db.Uuid
  jurisdictionId String   @map("jurisdiction_id") @db.Uuid
  purpose        String   @db.Text // forms|fees|schedule|ordinance|applications
  url            String   @db.Text
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)

  @@index([jurisdictionId])
  @@map("jurisdiction_seed_sources")
}

model Deal {
  id              String      @id @default(uuid()) @db.Uuid
  orgId           String      @map("org_id") @db.Uuid
  name            String      @db.Text
  sku             sku_type
  jurisdictionId  String      @map("jurisdiction_id") @db.Uuid
  status          deal_status @default(INTAKE)
  targetCloseDate DateTime?   @map("target_close_date") @db.Date
  notes           String?     @db.Text
  createdBy       String      @map("created_by") @db.Uuid
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  source                    String?  @db.Text
  financialModelAssumptions Json?    @map("financial_model_assumptions") @db.JsonB

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Restrict)
  creator      User         @relation("deal_created_by", fields: [createdBy], references: [id], onDelete: Restrict)

  parcels       Parcel[]
  tasks         Task[]
  outreach      Outreach[]
  runs          Run[]
  artifacts     Artifact[]
  uploads       Upload[]
  conversations Conversation[]
  entityDeals   EntityDeal[]
  taxEvents     TaxEvent[]
  notifications Notification[]

  @@index([orgId])
  @@index([jurisdictionId])
  @@index([status])
  @@map("deals")
}

model Parcel {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  dealId        String   @map("deal_id") @db.Uuid
  address       String   @db.Text
  apn           String?  @db.Text
  // Store coordinates/acreage as fixed-point decimals for determinism and DB portability.
  lat           Decimal? @db.Decimal(10, 7)
  lng           Decimal? @db.Decimal(10, 7)
  acreage       Decimal? @db.Decimal(12, 4)
  currentZoning  String?  @map("current_zoning") @db.Text
  futureLandUse  String?  @map("future_land_use") @db.Text
  utilitiesNotes String?  @map("utilities_notes") @db.Text
  floodZone      String?  @map("flood_zone") @db.Text
  soilsNotes     String?  @map("soils_notes") @db.Text
  wetlandsNotes  String?  @map("wetlands_notes") @db.Text
  envNotes       String?  @map("env_notes") @db.Text
  trafficNotes   String?  @map("traffic_notes") @db.Text
  propertyDbId   String?  @map("property_db_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@map("parcels")
}

model Task {
  id           String      @id @default(uuid()) @db.Uuid
  orgId        String      @map("org_id") @db.Uuid
  dealId       String      @map("deal_id") @db.Uuid
  title        String      @db.Text
  description  String?     @db.Text
  status       task_status @default(TODO)
  dueAt        DateTime?   @map("due_at") @db.Timestamptz(6)
  ownerUserId  String?     @map("owner_user_id") @db.Uuid
  pipelineStep Int         @map("pipeline_step")
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  owner User? @relation("task_owner_user_id", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([dealId])
  @@index([status])
  @@index([pipelineStep])
  @@map("tasks")
}

model Buyer {
  id                    String     @id @default(uuid()) @db.Uuid
  orgId                 String     @map("org_id") @db.Uuid
  name                  String     @db.Text
  company               String?    @db.Text
  email                 String?    @db.Text
  phone                 String?    @db.Text
  buyerType             String     @map("buyer_type") @db.Text // operator|developer|investor|broker
  skuInterests          sku_type[] @map("sku_interests")
  jurisdictionInterests String[]   @map("jurisdiction_interests") @db.Uuid
  notes                 String?    @db.Text
  createdAt             DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  outreach Outreach[]

  @@index([orgId])
  @@map("buyers")
}

model Outreach {
  id             String    @id @default(uuid()) @db.Uuid
  orgId          String    @map("org_id") @db.Uuid
  dealId         String    @map("deal_id") @db.Uuid
  buyerId        String    @map("buyer_id") @db.Uuid
  channel        String    @db.Text // call|email|text|in_person
  status         String    @db.Text // planned|sent|completed|no_response|not_interested
  lastContactAt  DateTime? @map("last_contact_at") @db.Timestamptz(6)
  nextFollowupAt DateTime? @map("next_followup_at") @db.Timestamptz(6)
  notes          String?   @db.Text

  org   Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  buyer Buyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@index([buyerId])
  @@map("outreach")
}

model Run {
  id              String    @id @default(uuid()) @db.Uuid
  orgId           String    @map("org_id") @db.Uuid
  runType         run_type  @map("run_type")
  dealId          String?   @map("deal_id") @db.Uuid
  jurisdictionId  String?   @map("jurisdiction_id") @db.Uuid
  sku             sku_type?
  status          String    @db.Text // running|succeeded|failed|canceled
  startedAt       DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  finishedAt      DateTime? @map("finished_at") @db.Timestamptz(6)
  error           String?   @db.Text
  openaiResponseId String?  @map("openai_response_id") @db.Text
  inputHash       String?   @map("input_hash") @db.Text
  outputJson      Json?     @map("output_json")

  org          Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction? @relation(fields: [jurisdictionId], references: [id], onDelete: SetNull)

  evidenceSnapshots   EvidenceSnapshot[]
  parishPackVersions  ParishPackVersion[]
  artifacts           Artifact[]

  @@index([orgId])
  @@index([dealId])
  @@index([jurisdictionId])
  @@index([runType])
  @@map("runs")
}

model EvidenceSource {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  url         String   @db.Text
  domain      String   @db.Text
  title       String?  @db.Text
  isOfficial  Boolean  @default(false) @map("is_official")
  firstSeenAt DateTime @default(now()) @map("first_seen_at") @db.Timestamptz(6)

  org              Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  evidenceSnapshots EvidenceSnapshot[]

  @@unique([orgId, url])
  @@index([orgId])
  @@index([domain])
  @@map("evidence_sources")
}

model EvidenceSnapshot {
  id                 String   @id @default(uuid()) @db.Uuid
  orgId              String   @map("org_id") @db.Uuid
  evidenceSourceId   String   @map("evidence_source_id") @db.Uuid
  retrievedAt        DateTime @map("retrieved_at") @db.Timestamptz(6)
  httpStatus         Int      @map("http_status")
  contentType        String   @map("content_type") @db.Text
  contentHash        String   @map("content_hash") @db.Text
  storageObjectKey   String   @map("storage_object_key") @db.Text
  textExtractObjectKey String? @map("text_extract_object_key") @db.Text
  runId              String   @map("run_id") @db.Uuid

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  evidenceSource EvidenceSource @relation(fields: [evidenceSourceId], references: [id], onDelete: Cascade)
  run          Run          @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([evidenceSourceId])
  @@index([runId])
  @@map("evidence_snapshots")
}

model ParishPackVersion {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  jurisdictionId  String   @map("jurisdiction_id") @db.Uuid
  sku             sku_type
  version         Int
  status          String   @db.Text // draft|current|superseded|invalid
  generatedAt     DateTime @map("generated_at") @db.Timestamptz(6)
  generatedByRunId String  @map("generated_by_run_id") @db.Uuid
  packJson        Json     @map("pack_json")

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  run          Run          @relation(fields: [generatedByRunId], references: [id], onDelete: Cascade)

  @@unique([jurisdictionId, sku, version])
  @@index([orgId])
  @@index([jurisdictionId])
  @@index([status])
  @@map("parish_pack_versions")
}

model Artifact {
  id              String        @id @default(uuid()) @db.Uuid
  orgId           String        @map("org_id") @db.Uuid
  dealId          String        @map("deal_id") @db.Uuid
  artifactType    artifact_type @map("artifact_type")
  version         Int
  storageObjectKey String       @map("storage_object_key") @db.Text
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  generatedByRunId String       @map("generated_by_run_id") @db.Uuid

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  run  Run  @relation(fields: [generatedByRunId], references: [id], onDelete: Cascade)

  @@unique([dealId, artifactType, version])
  @@index([orgId])
  @@index([dealId])
  @@map("artifacts")
}

model Upload {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  dealId          String   @map("deal_id") @db.Uuid
  kind            String   @db.Text
  filename        String   @db.Text
  contentType     String   @map("content_type") @db.Text
  sizeBytes       Int      @map("size_bytes")
  storageObjectKey String  @map("storage_object_key") @db.Text
  uploadedBy      String   @map("uploaded_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user User @relation("upload_uploaded_by", fields: [uploadedBy], references: [id], onDelete: Restrict)

  @@index([orgId])
  @@index([dealId])
  @@map("uploads")
}

model Conversation {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  dealId    String?  @map("deal_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal     Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([orgId])
  @@index([dealId])
  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  role           String   @db.Text // user|assistant|system|tool
  content        String   @db.Text
  agentName      String?  @map("agent_name") @db.Text
  toolCalls      Json?    @map("tool_calls")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

model Entity {
  id            String      @id @default(uuid()) @db.Uuid
  orgId         String      @map("org_id") @db.Uuid
  name          String      @db.Text
  entityType    entity_type @map("entity_type")
  parentId      String?     @map("parent_id") @db.Uuid
  ownershipPct  Decimal     @default(100) @map("ownership_pct") @db.Decimal(5, 2)
  taxId         String?     @map("tax_id") @db.Text
  state         String?     @db.Text
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  org       Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parent    Entity?      @relation("EntityHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Entity[]     @relation("EntityHierarchy")
  deals     EntityDeal[]
  taxEvents TaxEvent[]

  @@index([orgId])
  @@index([parentId])
  @@map("entities")
}

model EntityDeal {
  entityId     String  @map("entity_id") @db.Uuid
  dealId       String  @map("deal_id") @db.Uuid
  ownershipPct Decimal @default(100) @map("ownership_pct") @db.Decimal(5, 2)

  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@id([entityId, dealId])
  @@map("entity_deals")
}

model TaxEvent {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  entityId    String?   @map("entity_id") @db.Uuid
  dealId      String?   @map("deal_id") @db.Uuid
  eventType   String    @map("event_type") @db.Text
  title       String    @db.Text
  description String?   @db.Text
  severity    String    @db.Text
  deadline    DateTime? @db.Timestamptz(6)
  metadata    Json?
  status      String    @default("active") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  org    Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  entity Entity? @relation(fields: [entityId], references: [id], onDelete: SetNull)
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([entityId])
  @@index([dealId])
  @@map("tax_events")
}

model Notification {
  id          String                @id @default(uuid()) @db.Uuid
  orgId       String                @map("org_id") @db.Uuid
  userId      String                @map("user_id") @db.Uuid
  dealId      String?               @map("deal_id") @db.Uuid
  type        notification_type     @default(SYSTEM)
  title       String                @db.Text
  body        String                @db.Text
  metadata    Json                  @default("{}") @db.JsonB
  priority    notification_priority @default(MEDIUM)
  readAt      DateTime?             @map("read_at") @db.Timestamptz(6)
  dismissedAt DateTime?             @map("dismissed_at") @db.Timestamptz(6)
  actionUrl   String?               @map("action_url") @db.Text
  sourceAgent String?               @map("source_agent") @db.Text
  createdAt   DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)

  org  Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal? @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([userId, readAt])
  @@index([userId, createdAt(sort: Desc)])
  @@index([dealId])
  @@map("notifications")
}

model NotificationPreference {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  type            notification_type
  channel         String   @default("in_app") @db.Text // in_app|email|both
  enabled         Boolean  @default(true)
  thresholdConfig Json     @default("{}") @map("threshold_config") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("notification_preferences")
}

model SavedSearch {
  id             String          @id @default(uuid()) @db.Uuid
  orgId          String          @map("org_id") @db.Uuid
  userId         String          @map("user_id") @db.Uuid
  name           String          @db.Text
  criteria       Json            @default("{}") @db.JsonB
  alertEnabled   Boolean         @default(false) @map("alert_enabled")
  alertFrequency alert_frequency @default(DAILY) @map("alert_frequency")
  lastRunAt      DateTime?       @map("last_run_at") @db.Timestamptz(6)
  matchCount     Int             @default(0) @map("match_count")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy      String?         @map("created_by") @db.Uuid

  org     Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  matches OpportunityMatch[]

  @@index([orgId])
  @@index([userId])
  @@index([alertEnabled])
  @@map("saved_searches")
}

model OpportunityMatch {
  id              String    @id @default(uuid()) @db.Uuid
  savedSearchId   String    @map("saved_search_id") @db.Uuid
  parcelId        String    @map("parcel_id") @db.Uuid // Property DB parcel UUID
  matchScore      Decimal   @map("match_score") @db.Decimal(5, 2)
  matchedCriteria Json      @default("{}") @map("matched_criteria") @db.JsonB
  parcelData      Json      @default("{}") @map("parcel_data") @db.JsonB // Cached parcel info for display
  seenAt          DateTime? @map("seen_at") @db.Timestamptz(6)
  dismissedAt     DateTime? @map("dismissed_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  savedSearch SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  @@unique([savedSearchId, parcelId])
  @@index([savedSearchId])
  @@index([savedSearchId, seenAt])
  @@index([savedSearchId, dismissedAt])
  @@map("opportunity_matches")
}
