generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum sku_type {
  SMALL_BAY_FLEX
  OUTDOOR_STORAGE
  TRUCK_PARKING
}

enum deal_status {
  INTAKE
  TRIAGE_DONE
  PREAPP
  CONCEPT
  NEIGHBORS
  SUBMITTED
  HEARING
  APPROVED
  EXIT_MARKETED
  EXITED
  KILLED
}

enum task_status {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELED
}

enum artifact_type {
  TRIAGE_PDF
  SUBMISSION_CHECKLIST_PDF
  HEARING_DECK_PPTX
  EXIT_PACKAGE_PDF
  BUYER_TEASER_PDF
  INVESTMENT_MEMO_PDF
  OFFERING_MEMO_PDF
  COMP_ANALYSIS_PDF
  IC_DECK_PPTX
}

enum evidence_type {
  WEB_PAGE
  PDF
  IMAGE
  TEXT_EXTRACT
}

enum run_type {
  TRIAGE
  PARISH_PACK_REFRESH
  ARTIFACT_GEN
  BUYER_LIST_BUILD
  CHANGE_DETECT
  SOURCE_INGEST
  ENRICHMENT
  INTAKE_PARSE
  DOCUMENT_CLASSIFY
  BUYER_OUTREACH_DRAFT
  ADVANCEMENT_CHECK
  OPPORTUNITY_SCAN
  DEADLINE_MONITOR
}

enum alert_frequency {
  REALTIME
  DAILY
  WEEKLY
}

enum entity_type {
  LLC
  TRUST
  CORP
  INDIVIDUAL
  @@map("entity_type")
}

enum notification_type {
  ALERT
  OPPORTUNITY
  DEADLINE
  SYSTEM
  MARKET
  AUTOMATION
}

enum notification_priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum deal_stakeholder_role {
  SPONSOR
  EQUITY_PARTNER
  LENDER
  BROKER
  LAWYER
  TITLE_COMPANY
  CONTRACTOR
  OTHER
}

model Org {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships       OrgMembership[]
  jurisdictions     Jurisdiction[]
  deals             Deal[]
  parcels           Parcel[]
  tasks             Task[]
  buyers            Buyer[]
  outreach          Outreach[]
  runs              Run[]
  evidenceSources   EvidenceSource[]
  evidenceSnapshots EvidenceSnapshot[]
  parishPackVersions ParishPackVersion[]
  artifacts         Artifact[]
  uploads              Upload[]
  documentExtractions  DocumentExtraction[]
  conversations        Conversation[]
  entities          Entity[]
  taxEvents         TaxEvent[]
  notifications     Notification[]
  savedSearches     SavedSearch[]
  entitlementGraphNodes       EntitlementGraphNode[]
  entitlementGraphEdges       EntitlementGraphEdge[]
  entitlementOutcomePrecedents EntitlementOutcomePrecedent[]
  entitlementPredictionSnapshots EntitlementPredictionSnapshot[]
  dealTerms                DealTerms[]
  environmentalAssessments EnvironmentalAssessment[]
  tenants                 Tenant[]
  tenantLeases            TenantLease[]
  developmentBudgets      DevelopmentBudget[]
  financings              DealFinancing[]
  risks                   DealRisk[]
  entitlementPaths          EntitlementPath[]
  stakeholders            DealStakeholder[]
  propertyTitles          PropertyTitle[]
  propertySurveys         PropertySurvey[]

  @@map("orgs")
}

model User {
  // Must match Supabase auth user id.
  id        String   @id @db.Uuid
  email     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  memberships            OrgMembership[]
  dealsCreated           Deal[]   @relation("deal_created_by")
  tasksOwned             Task[]   @relation("task_owner_user_id")
  uploadsCreated         Upload[] @relation("upload_uploaded_by")
  extractionsReviewed    DocumentExtraction[] @relation("extraction_reviewed_by")
  conversations          Conversation[]
  notifications          Notification[]
  notificationPreferences NotificationPreference[]
  savedSearches          SavedSearch[]

  @@map("users")
}

model OrgMembership {
  orgId     String   @map("org_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @db.Text // owner|admin|member
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@index([userId])
  @@map("org_memberships")
}

model Jurisdiction {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  name            String   @db.Text
  kind            String   @db.Text // parish|city
  state           String   @db.Text
  timezone        String   @db.Text
  officialDomains String[] @map("official_domains")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org         Org                    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  seedSources JurisdictionSeedSource[]
  deals       Deal[]
  parishPackVersions ParishPackVersion[]
  runs        Run[]
  entitlementGraphNodes       EntitlementGraphNode[]
  entitlementGraphEdges       EntitlementGraphEdge[]
  entitlementOutcomePrecedents EntitlementOutcomePrecedent[]
  entitlementPredictionSnapshots EntitlementPredictionSnapshot[]

  @@index([orgId])
  @@map("jurisdictions")
}

model JurisdictionSeedSource {
  id             String   @id @default(uuid()) @db.Uuid
  jurisdictionId String   @map("jurisdiction_id") @db.Uuid
  purpose        String   @db.Text // forms|fees|schedule|ordinance|applications
  url            String   @db.Text
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)

  @@index([jurisdictionId])
  @@map("jurisdiction_seed_sources")
}

model Deal {
  id              String      @id @default(uuid()) @db.Uuid
  orgId           String      @map("org_id") @db.Uuid
  name            String      @db.Text
  sku             sku_type
  jurisdictionId  String      @map("jurisdiction_id") @db.Uuid
  status          deal_status @default(INTAKE)
  targetCloseDate DateTime?   @map("target_close_date") @db.Date
  notes           String?     @db.Text
  createdBy       String      @map("created_by") @db.Uuid
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  source                    String?  @db.Text
  financialModelAssumptions Json?    @map("financial_model_assumptions") @db.JsonB
  financialModelScenarios   Json?    @map("financial_model_scenarios") @db.JsonB
  waterfallStructures       Json?    @map("waterfall_structures") @db.JsonB
  debtComparisons           Json?    @map("debt_comparisons") @db.JsonB

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Restrict)
  creator      User         @relation("deal_created_by", fields: [createdBy], references: [id], onDelete: Restrict)

  parcels       Parcel[]
  tasks         Task[]
  outreach      Outreach[]
  runs          Run[]
  artifacts     Artifact[]
  uploads              Upload[]
  documentExtractions  DocumentExtraction[]
  conversations        Conversation[]
  entityDeals      EntityDeal[]
  taxEvents        TaxEvent[]
  notifications    Notification[]
  approvalRequests ApprovalRequest[]
  outcome          DealOutcome?
  terms            DealTerms?
  entitlementPath  EntitlementPath?
  propertyTitle    PropertyTitle?
  propertySurvey   PropertySurvey?
  environmentalAssessments EnvironmentalAssessment[]
  tenants        Tenant[]
  tenantLeases   TenantLease[]
  developmentBudget DevelopmentBudget?
  financings       DealFinancing[]
  risks            DealRisk[]
  stakeholders     DealStakeholder[]
  assumptionActuals AssumptionActual[]
  entitlementGraphNodes       EntitlementGraphNode[]
  entitlementOutcomePrecedents EntitlementOutcomePrecedent[]
  entitlementPredictionSnapshots EntitlementPredictionSnapshot[]

  @@index([orgId])
  @@index([jurisdictionId])
  @@index([status])
  @@map("deals")
}

model Parcel {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  dealId        String   @map("deal_id") @db.Uuid
  address       String   @db.Text
  apn           String?  @db.Text
  // Store coordinates/acreage as fixed-point decimals for determinism and DB portability.
  lat           Decimal? @db.Decimal(10, 7)
  lng           Decimal? @db.Decimal(10, 7)
  acreage       Decimal? @db.Decimal(12, 4)
  currentZoning  String?  @map("current_zoning") @db.Text
  futureLandUse  String?  @map("future_land_use") @db.Text
  utilitiesNotes String?  @map("utilities_notes") @db.Text
  floodZone      String?  @map("flood_zone") @db.Text
  soilsNotes     String?  @map("soils_notes") @db.Text
  wetlandsNotes  String?  @map("wetlands_notes") @db.Text
  envNotes       String?  @map("env_notes") @db.Text
  trafficNotes   String?  @map("traffic_notes") @db.Text
  propertyDbId   String?  @map("property_db_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@map("parcels")
}

model Task {
  id           String      @id @default(uuid()) @db.Uuid
  orgId        String      @map("org_id") @db.Uuid
  dealId       String      @map("deal_id") @db.Uuid
  title        String      @db.Text
  description  String?     @db.Text
  status       task_status @default(TODO)
  dueAt        DateTime?   @map("due_at") @db.Timestamptz(6)
  ownerUserId  String?     @map("owner_user_id") @db.Uuid
  pipelineStep Int         @map("pipeline_step")
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  owner User? @relation("task_owner_user_id", fields: [ownerUserId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([dealId])
  @@index([status])
  @@index([pipelineStep])
  @@map("tasks")
}

model Buyer {
  id                    String     @id @default(uuid()) @db.Uuid
  orgId                 String     @map("org_id") @db.Uuid
  name                  String     @db.Text
  company               String?    @db.Text
  email                 String?    @db.Text
  phone                 String?    @db.Text
  buyerType             String     @map("buyer_type") @db.Text // operator|developer|investor|broker
  skuInterests          sku_type[] @map("sku_interests")
  jurisdictionInterests String[]   @map("jurisdiction_interests") @db.Uuid
  notes                 String?    @db.Text
  createdAt             DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)

  org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  outreach Outreach[]

  @@index([orgId])
  @@map("buyers")
}

model Outreach {
  id             String    @id @default(uuid()) @db.Uuid
  orgId          String    @map("org_id") @db.Uuid
  dealId         String    @map("deal_id") @db.Uuid
  buyerId        String    @map("buyer_id") @db.Uuid
  channel        String    @db.Text // call|email|text|in_person
  status         String    @db.Text // planned|sent|completed|no_response|not_interested
  lastContactAt  DateTime? @map("last_contact_at") @db.Timestamptz(6)
  nextFollowupAt DateTime? @map("next_followup_at") @db.Timestamptz(6)
  notes          String?   @db.Text

  org   Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  buyer Buyer @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@index([buyerId])
  @@map("outreach")
}

model Run {
  id              String    @id @default(uuid()) @db.Uuid
  orgId           String    @map("org_id") @db.Uuid
  runType         run_type  @map("run_type")
  dealId          String?   @map("deal_id") @db.Uuid
  jurisdictionId  String?   @map("jurisdiction_id") @db.Uuid
  sku             sku_type?
  status          String    @db.Text // running|succeeded|failed|canceled
  startedAt       DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  finishedAt      DateTime? @map("finished_at") @db.Timestamptz(6)
  error           String?   @db.Text
  openaiResponseId String?  @map("openai_response_id") @db.Text
  inputHash       String?   @map("input_hash") @db.Text
  outputJson      Json?     @map("output_json")
  serializedState Json?     @map("serialized_state")

  org          Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction? @relation(fields: [jurisdictionId], references: [id], onDelete: SetNull)

  evidenceSnapshots   EvidenceSnapshot[]
  parishPackVersions  ParishPackVersion[]
  artifacts           Artifact[]

  @@index([orgId])
  @@index([dealId])
  @@index([jurisdictionId])
  @@index([runType])
  @@map("runs")
}

model EvidenceSource {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  url         String   @db.Text
  domain      String   @db.Text
  title       String?  @db.Text
  isOfficial  Boolean  @default(false) @map("is_official")
  firstSeenAt DateTime @default(now()) @map("first_seen_at") @db.Timestamptz(6)

  org              Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  evidenceSnapshots EvidenceSnapshot[]

  @@unique([orgId, url])
  @@index([orgId])
  @@index([domain])
  @@map("evidence_sources")
}

model EvidenceSnapshot {
  id                 String   @id @default(uuid()) @db.Uuid
  orgId              String   @map("org_id") @db.Uuid
  evidenceSourceId   String   @map("evidence_source_id") @db.Uuid
  retrievedAt        DateTime @map("retrieved_at") @db.Timestamptz(6)
  httpStatus         Int      @map("http_status")
  contentType        String   @map("content_type") @db.Text
  contentHash        String   @map("content_hash") @db.Text
  storageObjectKey   String   @map("storage_object_key") @db.Text
  textExtractObjectKey String? @map("text_extract_object_key") @db.Text
  runId              String   @map("run_id") @db.Uuid

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  evidenceSource EvidenceSource @relation(fields: [evidenceSourceId], references: [id], onDelete: Cascade)
  run          Run          @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([evidenceSourceId])
  @@index([runId])
  @@map("evidence_snapshots")
}

model ParishPackVersion {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  jurisdictionId  String   @map("jurisdiction_id") @db.Uuid
  sku             sku_type
  version         Int
  status          String   @db.Text // draft|current|superseded|invalid
  generatedAt     DateTime @map("generated_at") @db.Timestamptz(6)
  generatedByRunId String  @map("generated_by_run_id") @db.Uuid
  packJson        Json     @map("pack_json")
  sourceEvidenceIds   Json     @default("[]") @map("source_evidence_ids")
  sourceSnapshotIds   Json     @default("[]") @map("source_snapshot_ids")
  sourceContentHashes Json     @default("[]") @map("source_content_hashes")
  officialOnly        Boolean   @default(false) @map("official_only")
  sourceUrls          Json     @default("[]") @map("source_urls")
  packCoverageScore   Float?    @map("pack_coverage_score")
  canonicalSchemaVersion String? @map("canonical_schema_version") @db.Text
  coverageSourceCount Int?      @map("coverage_source_count")
  inputHash          String?   @map("input_hash") @db.Text

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  run          Run          @relation(fields: [generatedByRunId], references: [id], onDelete: Cascade)

  @@unique([jurisdictionId, sku, version])
  @@index([orgId])
  @@index([jurisdictionId])
  @@index([status])
  @@map("parish_pack_versions")
}

model Artifact {
  id              String        @id @default(uuid()) @db.Uuid
  orgId           String        @map("org_id") @db.Uuid
  dealId          String        @map("deal_id") @db.Uuid
  artifactType    artifact_type @map("artifact_type")
  version         Int
  storageObjectKey String       @map("storage_object_key") @db.Text
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  generatedByRunId String       @map("generated_by_run_id") @db.Uuid

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  run  Run  @relation(fields: [generatedByRunId], references: [id], onDelete: Cascade)

  @@unique([dealId, artifactType, version])
  @@index([orgId])
  @@index([dealId])
  @@map("artifacts")
}

model Upload {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  dealId          String   @map("deal_id") @db.Uuid
  kind            String   @db.Text
  filename        String   @db.Text
  contentType     String   @map("content_type") @db.Text
  sizeBytes       Int      @map("size_bytes")
  storageObjectKey String  @map("storage_object_key") @db.Text
  uploadedBy      String   @map("uploaded_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user User @relation("upload_uploaded_by", fields: [uploadedBy], references: [id], onDelete: Restrict)

  extractions DocumentExtraction[]

  @@index([orgId])
  @@index([dealId])
  @@map("uploads")
}

model DocumentExtraction {
  id            String    @id @default(uuid()) @db.Uuid
  orgId         String    @map("org_id") @db.Uuid
  uploadId      String    @map("upload_id") @db.Uuid
  dealId        String    @map("deal_id") @db.Uuid
  docType       String    @map("doc_type") @db.Text // psa, phase_i_esa, title_commitment, survey, zoning_letter, appraisal, lease, loi, other
  extractedData Json      @default("{}") @map("extracted_data") @db.JsonB
  rawText       String?   @map("raw_text") @db.Text
  confidence    Decimal   @default(0) @db.Decimal(4, 3)
  extractedAt   DateTime  @default(now()) @map("extracted_at") @db.Timestamptz(6)
  reviewed      Boolean   @default(false)
  reviewedBy    String?   @map("reviewed_by") @db.Uuid
  reviewedAt    DateTime? @map("reviewed_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  org      Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  upload   Upload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  deal     Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  reviewer User?  @relation("extraction_reviewed_by", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@unique([uploadId])
  @@index([orgId])
  @@index([dealId])
  @@index([dealId, reviewed])
  @@map("document_extractions")
}

model Conversation {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  dealId    String?  @map("deal_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal     Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([orgId])
  @@index([dealId])
  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  role           String   @db.Text // user|assistant|system|tool
  content        String   @db.Text
  agentName      String?  @map("agent_name") @db.Text
  toolCalls      Json?    @map("tool_calls")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

model Entity {
  id            String      @id @default(uuid()) @db.Uuid
  orgId         String      @map("org_id") @db.Uuid
  name          String      @db.Text
  entityType    entity_type @map("entity_type")
  parentId      String?     @map("parent_id") @db.Uuid
  ownershipPct  Decimal     @default(100) @map("ownership_pct") @db.Decimal(5, 2)
  taxId         String?     @map("tax_id") @db.Text
  state         String?     @db.Text
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  org       Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parent    Entity?      @relation("EntityHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Entity[]     @relation("EntityHierarchy")
  deals     EntityDeal[]
  taxEvents TaxEvent[]

  @@index([orgId])
  @@index([parentId])
  @@map("entities")
}

model EntityDeal {
  entityId     String  @map("entity_id") @db.Uuid
  dealId       String  @map("deal_id") @db.Uuid
  ownershipPct Decimal @default(100) @map("ownership_pct") @db.Decimal(5, 2)

  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@id([entityId, dealId])
  @@map("entity_deals")
}

model TaxEvent {
  id          String    @id @default(uuid()) @db.Uuid
  orgId       String    @map("org_id") @db.Uuid
  entityId    String?   @map("entity_id") @db.Uuid
  dealId      String?   @map("deal_id") @db.Uuid
  eventType   String    @map("event_type") @db.Text
  title       String    @db.Text
  description String?   @db.Text
  severity    String    @db.Text
  deadline    DateTime? @db.Timestamptz(6)
  metadata    Json?
  status      String    @default("active") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  org    Org     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  entity Entity? @relation(fields: [entityId], references: [id], onDelete: SetNull)
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([entityId])
  @@index([dealId])
  @@map("tax_events")
}

model Notification {
  id          String                @id @default(uuid()) @db.Uuid
  orgId       String                @map("org_id") @db.Uuid
  userId      String                @map("user_id") @db.Uuid
  dealId      String?               @map("deal_id") @db.Uuid
  type        notification_type     @default(SYSTEM)
  title       String                @db.Text
  body        String                @db.Text
  metadata    Json                  @default("{}") @db.JsonB
  priority    notification_priority @default(MEDIUM)
  readAt      DateTime?             @map("read_at") @db.Timestamptz(6)
  dismissedAt DateTime?             @map("dismissed_at") @db.Timestamptz(6)
  actionUrl   String?               @map("action_url") @db.Text
  sourceAgent String?               @map("source_agent") @db.Text
  createdAt   DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)

  org  Org   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal? @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([userId, readAt])
  @@index([userId, createdAt(sort: Desc)])
  @@index([dealId])
  @@map("notifications")
}

model NotificationPreference {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  type            notification_type
  channel         String   @default("in_app") @db.Text // in_app|email|both
  enabled         Boolean  @default(true)
  thresholdConfig Json     @default("{}") @map("threshold_config") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("notification_preferences")
}

model SavedSearch {
  id             String          @id @default(uuid()) @db.Uuid
  orgId          String          @map("org_id") @db.Uuid
  userId         String          @map("user_id") @db.Uuid
  name           String          @db.Text
  criteria       Json            @default("{}") @db.JsonB
  alertEnabled   Boolean         @default(false) @map("alert_enabled")
  alertFrequency alert_frequency @default(DAILY) @map("alert_frequency")
  lastRunAt      DateTime?       @map("last_run_at") @db.Timestamptz(6)
  matchCount     Int             @default(0) @map("match_count")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy      String?         @map("created_by") @db.Uuid

  org     Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  matches OpportunityMatch[]

  @@index([orgId])
  @@index([userId])
  @@index([alertEnabled])
  @@map("saved_searches")
}

model ApprovalRequest {
  id             String    @id @default(uuid()) @db.Uuid
  dealId         String    @map("deal_id") @db.Uuid
  requestedBy    String    @map("requested_by") @db.Uuid
  stageFrom      String    @map("stage_from") @db.Text
  stageTo        String    @map("stage_to") @db.Text
  status         String    @default("pending") @db.Text // pending|approved|rejected|changes_requested
  reviewerNotes  String?   @map("reviewer_notes") @db.Text
  decidedBy      String?   @map("decided_by") @db.Uuid
  decidedAt      DateTime? @map("decided_at") @db.Timestamptz(6)
  supportingData Json      @default("{}") @map("supporting_data") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([status])
  @@index([requestedBy])
  @@map("approval_requests")
}

model MarketDataPoint {
  id         String   @id @default(uuid()) @db.Uuid
  parish     String   @db.Text
  dataType   String   @map("data_type") @db.Text // comp_sale|listing|permit|vacancy|rent
  source     String   @db.Text
  data       Json     @default("{}") @db.JsonB
  observedAt DateTime @map("observed_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([parish])
  @@index([dataType])
  @@index([observedAt(sort: Desc)])
  @@index([parish, dataType])
  @@map("market_data_points")
}

model AutomationEvent {
  id          String    @id @default(uuid()) @db.Uuid
  dealId      String?   @map("deal_id") @db.Uuid
  handlerName String    @map("handler_name") @db.Text
  eventType   String    @map("event_type") @db.Text
  status      String    @db.Text // pending|running|completed|failed
  inputData   Json      @default("{}") @map("input_data") @db.JsonB
  outputData  Json      @default("{}") @map("output_data") @db.JsonB
  error       String?   @db.Text
  startedAt   DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs  Int?      @map("duration_ms")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([dealId])
  @@index([handlerName])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@map("automation_events")
}

model OpportunityMatch {
  id              String    @id @default(uuid()) @db.Uuid
  savedSearchId   String    @map("saved_search_id") @db.Uuid
  parcelId        String    @map("parcel_id") @db.Uuid // Property DB parcel UUID
  matchScore      Decimal   @map("match_score") @db.Decimal(5, 2)
  matchedCriteria Json      @default("{}") @map("matched_criteria") @db.JsonB
  parcelData      Json      @default("{}") @map("parcel_data") @db.JsonB // Cached parcel info for display
  seenAt          DateTime? @map("seen_at") @db.Timestamptz(6)
  dismissedAt     DateTime? @map("dismissed_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  savedSearch SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  @@unique([savedSearchId, parcelId])
  @@index([savedSearchId])
  @@index([savedSearchId, seenAt])
  @@index([savedSearchId, dismissedAt])
  @@map("opportunity_matches")
}

model KnowledgeEmbedding {
  id          String   @id @default(uuid()) @db.Uuid
  contentType String   @map("content_type") @db.Text // deal_memo|agent_analysis|document_extraction|market_report|user_note
  sourceId    String   @map("source_id") @db.Text // polymorphic reference
  contentText String   @map("content_text") @db.Text
  embedding   Unsupported("vector(1536)")?
  metadata    Json     @default("{}") @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([contentType])
  @@index([sourceId])
  @@map("knowledge_embeddings")
}

model EntitlementGraphNode {
  id             String   @id @default(uuid()) @db.Uuid
  orgId          String   @map("org_id") @db.Uuid
  jurisdictionId String   @map("jurisdiction_id") @db.Uuid
  dealId         String?  @map("deal_id") @db.Uuid
  nodeType       String   @map("node_type") @db.Text // strategy_path|jurisdiction_rule|condition|hearing_body|timeline_distribution|precedent_case
  nodeKey        String   @map("node_key") @db.Text
  label          String   @db.Text
  attributes     Json     @default("{}") @db.JsonB
  confidence     Decimal  @default(0.5000) @db.Decimal(5, 4)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  deal         Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)

  outgoingEdges EntitlementGraphEdge[] @relation("graph_edge_from")
  incomingEdges EntitlementGraphEdge[] @relation("graph_edge_to")
  strategyPrecedents EntitlementOutcomePrecedent[] @relation("strategy_node_precedents")

  @@unique([orgId, jurisdictionId, nodeType, nodeKey])
  @@index([orgId])
  @@index([jurisdictionId])
  @@index([dealId])
  @@index([nodeType])
  @@index([nodeKey])
  @@map("entitlement_graph_nodes")
}

model EntitlementGraphEdge {
  id             String   @id @default(uuid()) @db.Uuid
  orgId          String   @map("org_id") @db.Uuid
  jurisdictionId String   @map("jurisdiction_id") @db.Uuid
  fromNodeId     String   @map("from_node_id") @db.Uuid
  toNodeId       String   @map("to_node_id") @db.Uuid
  edgeType       String   @map("edge_type") @db.Text // requires|influences|accelerates|blocks|historical_precedent
  weight         Decimal  @default(1) @db.Decimal(6, 4)
  metadata       Json     @default("{}") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  fromNode     EntitlementGraphNode @relation("graph_edge_from", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode       EntitlementGraphNode @relation("graph_edge_to", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([orgId, jurisdictionId, fromNodeId, toNodeId, edgeType])
  @@index([orgId])
  @@index([jurisdictionId])
  @@index([fromNodeId])
  @@index([toNodeId])
  @@index([edgeType])
  @@map("entitlement_graph_edges")
}

model EntitlementOutcomePrecedent {
  id               String    @id @default(uuid()) @db.Uuid
  orgId            String    @map("org_id") @db.Uuid
  jurisdictionId   String    @map("jurisdiction_id") @db.Uuid
  dealId           String?   @map("deal_id") @db.Uuid
  strategyNodeId   String?   @map("strategy_node_id") @db.Uuid
  precedentKey     String    @map("precedent_key") @db.Text
  strategyKey      String    @map("strategy_key") @db.Text
  strategyLabel    String    @map("strategy_label") @db.Text
  sku              sku_type?
  applicationType  String?   @map("application_type") @db.Text
  hearingBody      String?   @map("hearing_body") @db.Text
  submittedAt      DateTime? @map("submitted_at") @db.Date
  decisionAt       DateTime? @map("decision_at") @db.Date
  decision         String    @db.Text // approved|approved_with_conditions|denied|withdrawn
  timelineDays     Int?      @map("timeline_days")
  conditions       Json      @default("[]") @db.JsonB
  riskFlags        String[]  @default([]) @map("risk_flags")
  sourceEvidenceIds String[] @default([]) @map("source_evidence_ids")
  sourceSnapshotIds String[] @default([]) @map("source_snapshot_ids")
  confidence       Decimal   @default(0.7000) @db.Decimal(5, 4)
  notes            String?   @db.Text
  createdBy        String?   @map("created_by") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  deal         Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)
  strategyNode EntitlementGraphNode? @relation("strategy_node_precedents", fields: [strategyNodeId], references: [id], onDelete: SetNull)

  @@unique([orgId, jurisdictionId, precedentKey])
  @@index([orgId])
  @@index([jurisdictionId])
  @@index([dealId])
  @@index([strategyKey])
  @@index([decision])
  @@index([decisionAt])
  @@map("entitlement_outcome_precedents")
}

model EntitlementPredictionSnapshot {
  id                    String    @id @default(uuid()) @db.Uuid
  orgId                 String    @map("org_id") @db.Uuid
  jurisdictionId        String    @map("jurisdiction_id") @db.Uuid
  dealId                String?   @map("deal_id") @db.Uuid
  strategyKey           String    @map("strategy_key") @db.Text
  strategyLabel         String    @map("strategy_label") @db.Text
  sku                   sku_type?
  probabilityApproval   Decimal   @map("probability_approval") @db.Decimal(6, 5)
  probabilityLow        Decimal   @map("probability_low") @db.Decimal(6, 5)
  probabilityHigh       Decimal   @map("probability_high") @db.Decimal(6, 5)
  expectedDaysP50       Int       @map("expected_days_p50")
  expectedDaysP75       Int       @map("expected_days_p75")
  expectedDaysP90       Int       @map("expected_days_p90")
  sampleSize            Int       @map("sample_size")
  modelVersion          String    @map("model_version") @db.Text
  inputHash             String    @map("input_hash") @db.Text
  rationale             Json      @default("{}") @db.JsonB
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  org          Org          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  deal         Deal?        @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@unique([orgId, jurisdictionId, strategyKey, inputHash])
  @@index([orgId])
  @@index([jurisdictionId])
  @@index([dealId])
  @@index([strategyKey])
  @@index([createdAt(sort: Desc)])
  @@map("entitlement_prediction_snapshots")
}

model DealOutcome {
  id                    String    @id @default(uuid()) @db.Uuid
  dealId                String    @unique @map("deal_id") @db.Uuid
  actualPurchasePrice   Decimal?  @map("actual_purchase_price") @db.Decimal(14, 2)
  actualNoiYear1        Decimal?  @map("actual_noi_year1") @db.Decimal(14, 2)
  actualExitPrice       Decimal?  @map("actual_exit_price") @db.Decimal(14, 2)
  actualIrr             Decimal?  @map("actual_irr") @db.Decimal(8, 4)
  actualEquityMultiple  Decimal?  @map("actual_equity_multiple") @db.Decimal(8, 4)
  actualHoldPeriodMonths Int?     @map("actual_hold_period_months")
  exitDate              DateTime? @map("exit_date") @db.Date
  exitType              String?   @map("exit_type") @db.Text // sale|refinance|1031|other
  killReason            String?   @map("kill_reason") @db.Text
  killWasCorrect        Boolean?  @map("kill_was_correct")
  notes                 String?   @db.Text
  createdBy             String    @map("created_by") @db.Uuid
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@map("deal_outcomes")
}

model DealTerms {
  id                      String     @id @default(uuid()) @db.Uuid
  dealId                  String     @unique @map("deal_id") @db.Uuid
  orgId                   String     @map("org_id") @db.Uuid
  offerPrice              Decimal?   @map("offer_price") @db.Decimal(14, 2)
  earnestMoney            Decimal?   @map("earnest_money") @db.Decimal(14, 2)
  closingDate             DateTime?  @map("closing_date") @db.Date
  titleCompany            String?    @map("title_company") @db.Text
  dueDiligenceDays        Int?       @map("due_diligence_days")
  financingContingencyDays Int?       @map("financing_contingency_days")
  loiSignedAt             DateTime?  @map("loi_signed_at") @db.Date
  psaSignedAt             DateTime?  @map("psa_signed_at") @db.Date
  titleReviewDue          DateTime?  @map("title_review_due") @db.Date
  surveyDue               DateTime?  @map("survey_due") @db.Date
  environmentalDue        DateTime?   @map("environmental_due") @db.Date
  sellerContact          String?      @map("seller_contact") @db.Text
  brokerContact          String?      @map("broker_contact") @db.Text
  createdAt              DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("deal_terms")
}

model EnvironmentalAssessment {
  id                     String     @id @default(uuid()) @db.Uuid
  dealId                 String     @map("deal_id") @db.Uuid
  orgId                  String     @map("org_id") @db.Uuid
  reportType             String?    @map("report_type") @db.Text
  reportDate             DateTime?  @map("report_date") @db.Date
  consultantName         String?    @map("consultant_name") @db.Text
  reportTitle            String?    @map("report_title") @db.Text
  recs                   String[]   @map("recs") @default([])
  deMinimisConditions    String[]   @map("de_minimis_conditions") @default([])
  phaseIiRecommended     Boolean?   @map("phase_ii_recommended")
  phaseIiScope           String?    @map("phase_ii_scope") @db.Text
  estimatedRemediationCost Decimal?  @map("estimated_remediation_cost") @db.Decimal(14, 2)
  sourceUploadId         String?    @map("source_upload_id") @db.Uuid
  notes                  String?    @db.Text
  createdAt              DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@index([reportDate])
  @@map("environmental_assessments")
}

model EntitlementPath {
  id                     String     @id @default(uuid()) @db.Uuid
  dealId                 String     @unique @map("deal_id") @db.Uuid
  orgId                  String     @map("org_id") @db.Uuid
  recommendedStrategy    String?     @map("recommended_strategy") @db.Text
  preAppMeetingDate      DateTime?  @map("pre_app_meeting_date") @db.Date
  preAppMeetingNotes     String?    @map("pre_app_meeting_notes") @db.Text
  applicationType        String?    @map("application_type") @db.Text
  applicationSubmittedDate DateTime? @map("application_submitted_date") @db.Date
  applicationNumber      String?    @map("application_number") @db.Text
  publicNoticeDate       DateTime?  @map("public_notice_date") @db.Date
  publicNoticePeriodDays Int?       @map("public_notice_period_days")
  hearingScheduledDate   DateTime?  @map("hearing_scheduled_date") @db.Date
  hearingBody            String?    @map("hearing_body") @db.Text
  hearingNotes           String?    @map("hearing_notes") @db.Text
  decisionDate           DateTime?  @map("decision_date") @db.Date
  decisionType           String?    @map("decision_type") @db.Text
  conditions             String[]   @map("conditions") @default([])
  appealDeadline         DateTime?  @map("appeal_deadline") @db.Date
  appealFiled            Boolean?   @map("appeal_filed")
  conditionComplianceStatus String?  @map("condition_compliance_status") @db.Text
  createdAt              DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("entitlement_paths")
}

model PropertyTitle {
  id                    String     @id @default(uuid()) @db.Uuid
  dealId                String     @map("deal_id") @db.Uuid
  orgId                 String     @map("org_id") @db.Uuid
  titleInsuranceReceived Boolean?   @map("title_insurance_received")
  exceptions            String[]   @map("exceptions") @default([])
  liens                 String[]   @map("liens") @default([])
  easements             String[]   @map("easements") @default([])
  createdAt             DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@unique([dealId])
  @@map("property_titles")
}

model PropertySurvey {
  id                 String     @id @default(uuid()) @db.Uuid
  dealId             String     @map("deal_id") @db.Uuid
  orgId              String     @map("org_id") @db.Uuid
  surveyCompletedDate DateTime?  @map("survey_completed_date") @db.Date
  acreageConfirmed   Decimal?   @map("acreage_confirmed") @db.Decimal(12, 4)
  encroachments      String[]   @map("encroachments") @default([])
  setbacks           Json       @default("{}") @map("setbacks") @db.JsonB
  createdAt          DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@unique([dealId])
  @@map("property_surveys")
}

model Tenant {
  id          String        @id @default(uuid()) @db.Uuid
  dealId      String        @map("deal_id") @db.Uuid
  orgId       String        @map("org_id") @db.Uuid
  name        String        @map("name") @db.Text
  contactName String?       @map("contact_name") @db.Text
  email       String?       @map("email") @db.Text
  phone       String?       @map("phone") @db.Text
  notes       String?       @map("notes") @db.Text
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  org          Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal         Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  tenantLeases TenantLease[]

  @@index([orgId])
  @@index([dealId])
  @@map("tenants")
}

model TenantLease {
  id                 String         @id @default(uuid()) @db.Uuid
  dealId             String         @map("deal_id") @db.Uuid
  orgId              String         @map("org_id") @db.Uuid
  tenantId           String         @map("tenant_id") @db.Uuid
  leaseName          String?        @map("lease_name") @db.Text
  startDate          DateTime       @map("start_date") @db.Date
  endDate            DateTime       @map("end_date") @db.Date
  rentedAreaSf       Decimal        @map("rented_area_sf") @db.Decimal(12, 4)
  rentPerSf          Decimal        @map("rent_per_sf") @db.Decimal(10, 4)
  annualEscalationPct Decimal        @default(0) @map("annual_escalation_pct") @db.Decimal(6, 4)
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  org    Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([tenantId])
  @@index([dealId])
  @@map("tenant_leases")
}

model DevelopmentBudget {
  id            String   @id @default(uuid()) @db.Uuid
  dealId        String   @unique @map("deal_id") @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  lineItems     Json     @default("[]") @map("line_items") @db.JsonB
  contingencies Json     @default("{}") @map("contingencies") @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@map("development_budgets")
}

model DealFinancing {
  id                    String     @id @default(uuid()) @db.Uuid
  dealId                String     @map("deal_id") @db.Uuid
  orgId                 String     @map("org_id") @db.Uuid
  lenderName            String?    @map("lender_name") @db.Text
  facilityName          String?    @map("facility_name") @db.Text
  loanType              String?    @map("loan_type") @db.Text
  loanAmount            Decimal?   @map("loan_amount") @db.Decimal(14, 2)
  commitmentDate        DateTime?  @map("commitment_date") @db.Date
  fundedDate            DateTime?  @map("funded_date") @db.Date
  interestRate          Decimal?   @map("interest_rate") @db.Decimal(6, 4)
  loanTermMonths        Int?       @map("loan_term_months")
  amortizationYears     Int?       @map("amortization_years")
  ltvPercent            Decimal?   @map("ltv_percent") @db.Decimal(6, 4)
  dscrRequirement       Decimal?   @map("dscr_requirement") @db.Decimal(6, 4)
  originationFeePercent Decimal?   @map("origination_fee_percent") @db.Decimal(6, 4)
  sourceUploadId        String?    @map("source_upload_id") @db.Uuid
  status                String?    @map("status") @db.Text
  notes                 String?    @db.Text
  createdAt             DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@map("deal_financings")
}

model DealRisk {
  id          String   @id @default(uuid()) @db.Uuid
  dealId      String   @map("deal_id") @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  category    String?  @map("category") @db.Text
  title       String?  @map("title") @db.Text
  description String?  @map("description") @db.Text
  severity    String?  @map("severity") @db.Text
  status      String?  @map("status") @db.Text
  owner       String?  @map("owner") @db.Text
  source      String?  @map("source") @db.Text
  score       Int?     @map("score")
  notes       String?  @map("notes") @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@map("deal_risks")
}

model DealStakeholder {
  id              String                @id @default(uuid()) @db.Uuid
  dealId          String                @map("deal_id") @db.Uuid
  orgId           String                @map("org_id") @db.Uuid
  role            deal_stakeholder_role @map("role")
  name            String                @map("name") @db.Text
  company         String?               @map("company") @db.Text
  email           String?               @map("email") @db.Text
  phone           String?               @map("phone") @db.Text
  equityOwnership Decimal?              @map("equity_ownership") @db.Decimal(6, 4)
  decisionRights  String[]              @map("decision_rights") @default([])
  notes           String?               @map("notes") @db.Text
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)

  org   Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deal  Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([dealId])
  @@map("deal_stakeholders")
}

model AssumptionActual {
  id              String    @id @default(uuid()) @db.Uuid
  dealId          String    @map("deal_id") @db.Uuid
  assumptionName  String    @map("assumption_name") @db.Text
  projectedValue  Decimal   @map("projected_value") @db.Decimal(14, 4)
  actualValue     Decimal?  @map("actual_value") @db.Decimal(14, 4)
  variancePct     Decimal?  @map("variance_pct") @db.Decimal(8, 4)
  recordedAt      DateTime  @default(now()) @map("recorded_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([assumptionName])
  @@map("assumption_actuals")
}
